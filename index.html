<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ìš°ë¦¬ì§‘ ë…¸íŠ¸(ëª¨ë°”ì¼)</title>
    <link rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles_m.css" />
    
         <!-- Supabase JS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
     <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js" onerror="console.error('Supabase CDN ë¡œë”© ì‹¤íŒ¨')"></script>
     <script src="./supabase.js" onerror="console.error('supabase.js ë¡œë”© ì‹¤íŒ¨')"></script>
     <!-- authCheck.js: window.isExecutingAction === true ë˜ëŠ” window.isSwitchingTab === true ì¼ ë•ŒëŠ” ì¸ì¦ ì²´í¬ë¥¼ ìš°íšŒí•´ì•¼ í•¨ -->
     <script src="./authCheck.js" onerror="console.error('authCheck.js ë¡œë”© ì‹¤íŒ¨')"></script>
     
  </head>
  <body>
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <div class="nav-bar">
      <button id="editorPageBtn" class="nav-btn active">
        <span class="nav-text">ë…¸íŠ¸ì‘ì„±/í¸ì§‘</span>
      </button>
      <button id="notesPageBtn" class="nav-btn">
        <span class="nav-text">ë…¸íŠ¸ì¡°íšŒ</span>
      </button>
    </div>

    <!-- í—¤ë” ë¶€ë¶„: ì§ì›ë²ˆí˜¸ì™€ ì§ì›ëª… í‘œì‹œ -->
    <div class="header" id="headerSection">
      <div class="title">ìš°ë¦¬ì§‘ ë…¸íŠ¸(ëª¨ë°”ì¼)
      </div>
      <div class="user-info">
        <span id="userEmployeeNumber">-</span> | <span id="userEmployeeName">-</span>
      </div>
    </div>

    <!-- í˜ì´ì§€ 1: ì‘ì„±/í¸ì§‘ ì„¹ì…˜ -->
    <div id="editorPage" class="page active">
      <div class="editor-section">
        <form id="mainNoteForm" class="main-form">
          <div class="form-group inline-group-horizontal">
            <label>êµ¬ë¶„:</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="category" value="ì„¼í„°ì¥" checked>
                <span>ì„¼í„°ì¥</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="category" value="ê°œì¸">
                <span>ê°œì¸</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="category" value="ì „ì²´">
                <span>ì „ì²´</span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="form-row">
              <div class="form-col">
                <label for="mainDate">ë…¸íŠ¸ë‚ ì§œ:</label>
                <input type="date" id="mainDate" required>
              </div>
              <div class="form-col">
                <label for="mainNumber">ë…¸íŠ¸ë²ˆí˜¸:</label>
                <input type="text" id="mainNumber" readonly>
              </div>
            </div>
          </div>

          <div class="form-group">
            <div class="tag-input-wrapper">
              <div class="tag-input-row">
                <label for="mainTag">íƒœê·¸:</label>
                <input type="text" id="mainTag" class="tag-input-field" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”">
                <input type="hidden" id="mainTagHidden">
              </div>
              <div class="tag-chips" id="mainTagChips"></div>
            </div>
            <div class="tag-examples">
              <span class="tag-label">ì˜ˆì‹œ:</span>
              <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="íšŒì›ìƒë‹´">íšŒì›ìƒë‹´</button>
              <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="ë³´í˜¸ììš”ì²­">ë³´í˜¸ììš”ì²­</button>
              <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="íšŒì›ìš”ì²­">íšŒì›ìš”ì²­</button>
              <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="íšŒì›ì´ìŠˆ">íšŒì›ì´ìŠˆ</button>
              <button type="button" class="tag-example-btn" data-target="mainTag" data-tag="ì¤€ë¹„ì‚¬í•­">ì¤€ë¹„ì‚¬í•­</button>
            </div>
          </div>

          <div class="form-group textarea-container">
            <label for="mainContent">ë…¸íŠ¸ë‚´ìš©:</label>
            <textarea id="mainContent" rows="8" required placeholder="ë…¸íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          </div>

          <!-- ê²Œì‹œì—¬ë¶€ -->
          <div class="form-group publish-container">
            <div class="inline-group-horizontal">
              <label>ê²Œì‹œì—¬ë¶€:</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="publish" value="Y" checked>
                  <span>Y</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="publish" value="N">
                  <span>N</span>
                </label>
              </div>
            </div>
          </div>

          <!-- ë²„íŠ¼ ì˜ì—­ -->
          <div class="button-section">
            <button type="button" id="resetMainBtn" class="action-btn reset-btn">ì´ˆê¸°í™”</button>
            <button type="button" id="saveMainBtn" class="action-btn save-btn">ì €ì¥</button>
            <button type="button" id="editMainBtn" class="action-btn edit-btn" disabled>ìˆ˜ì •</button>
            <button type="button" id="deleteMainBtn" class="action-btn delete-btn" disabled>ì‚­ì œ</button>
          </div>
        </form>
      </div>
      </div>
    </div>

    <!-- í˜ì´ì§€ 2: ë…¸íŠ¸ ì¡°íšŒ ì„¹ì…˜ -->
    <div id="notesPage" class="page">
      <!-- ê²€ìƒ‰ ì˜ì—­ -->
      <div class="search-section">
        <div class="search-controls">
          <!-- ì²« ë²ˆì§¸ ì¤„: ë‚ ì§œ ë²”ìœ„ -->
          <div class="search-row">
            <div class="search-field">
              <label>ì‹œì‘ì¼:</label>
              <input type="date" id="searchStartDate" placeholder="ì‹œì‘ì¼ ì„ íƒ">
            </div>
            <div class="search-field">
              <label>ì¢…ë£Œì¼:</label>
              <input type="date" id="searchEndDate" placeholder="ì¢…ë£Œì¼ ì„ íƒ">
            </div>
          </div>

          <!-- ë‘ ë²ˆì§¸ ì¤„ -->
          <div class="search-row">
            <div class="search-field">
              <label>íƒœê·¸:</label>
              <input type="text" id="searchTag" placeholder="íƒœê·¸ ê²€ìƒ‰">
            </div>
            <div class="search-field">
              <label>ë‚´ìš©:</label>
              <input type="text" id="searchContent" placeholder="ë‚´ìš© ê²€ìƒ‰">
            </div>
          </div>
          
          <!-- ì„¸ ë²ˆì§¸ ì¤„: ì§ì›ëª… ê²€ìƒ‰ + ê³µê°œì—¬ë¶€ í•„í„° -->
          <div class="search-row">
            <div class="search-field">
              <label>ì§ì›ëª…:</label>
              <input type="text" id="searchAuthor" placeholder="ì§ì›ëª… ê²€ìƒ‰">
            </div>
            <div class="publish-filter">
              <label>ë³´ê¸°:</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="publishFilter" value="published" checked>
                  <span>ê²Œì‹œë§Œ</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="publishFilter" value="all">
                  <span>ì „ì²´</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- ë„¤ ë²ˆì§¸ ì¤„: ê²€ìƒ‰ ë²„íŠ¼ -->
          <div class="search-row">
            <div class="search-buttons">
              <button id="searchBtn">ê²€ìƒ‰</button>
              <button id="resetBtn">ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ë…¸íŠ¸ ëª©ë¡ -->
      <div class="notes-list">
        <div id="notesContainer">
          <!-- ë™ì ìœ¼ë¡œ ë…¸íŠ¸ ì¹´ë“œë“¤ì´ ë“¤ì–´ê°ˆ ê³³ -->
        </div>
      </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ Alert ëª¨ë‹¬ -->
    <div id="customAlertModal" class="custom-modal">
      <div class="custom-modal-content alert-modal">
        <div class="custom-modal-header">
          <h3>ì•Œë¦¼</h3>
        </div>
        <div class="custom-modal-body">
          <p id="alertMessage"></p>
        </div>
        <div class="custom-modal-footer">
          <button type="button" id="alertOkBtn" class="custom-btn primary-btn">í™•ì¸</button>
        </div>
      </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ Confirm ëª¨ë‹¬ -->
    <div id="customConfirmModal" class="custom-modal">
      <div class="custom-modal-content confirm-modal">
        <div class="custom-modal-header">
          <h3>í™•ì¸</h3>
        </div>
        <div class="custom-modal-body">
          <p id="confirmMessage"></p>
        </div>
        <div class="custom-modal-footer">
          <button type="button" id="confirmCancelBtn" class="custom-btn secondary-btn">ì·¨ì†Œ</button>
          <button type="button" id="confirmOkBtn" class="custom-btn primary-btn">í™•ì¸</button>
        </div>
      </div>
    </div>

    <!-- ìˆ¨ê²¨ì§„ userInfo ìš”ì†Œ (parent pageì—ì„œ ì‚¬ë²ˆ ê°€ì ¸ì˜¤ê¸°ìš©) -->
    <div id="userInfo" style="display: none;"></div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let currentUser = '';
      let currentUserName = '';
      let selectedNoteId = null;
      let notes = [];
      let isEditMode = false;
      let isViewMode = false;
      
      // ì§ì› ì •ë³´ ìºì‹œ
      let employeesCache = null;
      let employeesCacheLoaded = false;
      
      // ë‚ ì§œ í•„í„° ê´€ë ¨ ë³€ìˆ˜
      let cachedNotes = []; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì›ë³¸ ë°ì´í„°
      let currentDateRange = { startDate: '', endDate: '' }; // í˜„ì¬ ì„¤ì •ëœ ë‚ ì§œ ë²”ìœ„

      // í˜ì´ì§€ ìƒíƒœ ë³€ìˆ˜
      let currentPage = 'editor'; // 'notes' ë˜ëŠ” 'editor'

      // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
      function getKoreaDate() {
        const now = new Date();
        const koreaOffset = 9 * 60; // UTC+9 (ë¶„ ë‹¨ìœ„)
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const koreaTime = new Date(utc + (koreaOffset * 60000));
        return koreaTime;
      }

      function getKoreaDateString(date = null) {
        const koreaDate = date || getKoreaDate();
        return koreaDate.toISOString().split('T')[0]; // yyyy-mm-dd í˜•ì‹
      }

      function getKoreaDateStringForDB(date = null) {
        const dateStr = getKoreaDateString(date);
        return dateStr.replace(/-/g, ''); // yyyymmdd í˜•ì‹
      }

      function getDateDaysAgo(days) {
        const koreaDate = getKoreaDate();
        koreaDate.setDate(koreaDate.getDate() - days);
        return koreaDate;
      }

      function initializeDateRange() {
        const today = getKoreaDateString();
        const twoWeeksAgo = getKoreaDateString(getDateDaysAgo(14));
        
        currentDateRange.startDate = twoWeeksAgo;
        currentDateRange.endDate = today;
        
        return { startDate: twoWeeksAgo, endDate: today };
      }

      // ì§ì› ì •ë³´ ì´ˆê¸°í™” ë° ìºì‹± (ëª¨ë°”ì¼ ìµœì í™”)
      async function initializeEmployeesCache() {
        if (employeesCacheLoaded) {
          return employeesCache;
        }
        
        try {
          console.log('ğŸ“‹ ì§ì› ì •ë³´ ë¡œë”© ì¤‘...');
          
          // ëª¨ë°”ì¼ì—ì„œ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹œê°„ ì´ˆê³¼')), 10000);
          });
          
          const employeesPromise = getEmployeesInfo();
          employeesCache = await Promise.race([employeesPromise, timeoutPromise]);
          
          employeesCacheLoaded = true;
          console.log('âœ… ì§ì› ì •ë³´ ë¡œë”© ì™„ë£Œ:', employeesCache.length, 'ëª…');
          return employeesCache;
        } catch (error) {
          console.error('âŒ ì§ì› ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', error);
          employeesCache = [];
          employeesCacheLoaded = true;
          
          // ëª¨ë°”ì¼ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          if (isMobileDevice()) {
            console.warn('ğŸ“± ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ì§ì› ì •ë³´ ë¡œë”© ì‹¤íŒ¨');
          }
          
          return employeesCache;
        }
      }

      // ìºì‹œëœ ì§ì› ì •ë³´ì—ì„œ ì§ì›ëª… ì°¾ê¸°
      function getEmployeeNameFromCache(employeeNumber) {
        if (!employeesCacheLoaded || !employeesCache) {
          return employeeNumber; // ìºì‹œê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì§ì›ë²ˆí˜¸ ë°˜í™˜
        }
        
        let employee = employeesCache.find(emp => emp.ì§ì›ë²ˆí˜¸ === employeeNumber);
        
        if (!employee) {
          employee = employeesCache.find(emp => 
            emp.ì§ì›ë²ˆí˜¸ && emp.ì§ì›ë²ˆí˜¸.toLowerCase() === employeeNumber.toLowerCase()
          );
        }
        
        return employee ? employee.ì§ì›ëª… : employeeNumber;
      }

      // ì§ì› ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
      function isValidEmployee(employeeNumber) {
        if (!employeeNumber) {
          return false;
        }

        if (!employeesCacheLoaded || !employeesCache) {
          return false;
        }

        if (employeeNumber === 'admin' || employeeNumber === 's25001') {
          return true;
        }

        const employee = employeesCache.find(emp => 
          emp.ì§ì›ë²ˆí˜¸ && emp.ì§ì›ë²ˆí˜¸.toLowerCase() === employeeNumber.toLowerCase()
        );

        return !!employee;
      }

      // í˜ì´ì§€ ì „ì²´ ë¹„í™œì„±í™” í•¨ìˆ˜ (ëª¨ë°”ì¼ìš©)
      function disablePageForUnauthorizedUser() {
        console.log('ğŸš« ë¬´íš¨í•œ ì§ì›ë²ˆí˜¸ - í˜ì´ì§€ ì „ì²´ ë¹„í™œì„±í™”');
        
        // ëª¨ë“  ì…ë ¥ ìš”ì†Œ ë¹„í™œì„±í™”
        const allInputs = document.querySelectorAll('input, textarea, button, select');
        allInputs.forEach(element => {
          element.disabled = true;
        });
        
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
        const navBtns = document.querySelectorAll('.nav-btn');
        navBtns.forEach(btn => {
          btn.style.pointerEvents = 'none';
          btn.style.opacity = '0.5';
        });
        
        // ë…¸íŠ¸ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
        const noteCards = document.querySelectorAll('.note-card');
        noteCards.forEach(card => {
          card.style.pointerEvents = 'none';
          card.style.opacity = '0.5';
        });
        
        // ëª¨ë°”ì¼ìš© ë¹„í™œì„±í™” ì˜¤ë²„ë ˆì´ ì¶”ê°€
        if (!document.getElementById('unauthorizedOverlay')) {
          const overlay = document.createElement('div');
          overlay.id = 'unauthorizedOverlay';
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1rem;
            text-align: center;
            font-family: "Noto Sans KR", "ë§‘ì€ ê³ ë”•", "Malgun Gothic", sans-serif;
            padding: 1rem;
            box-sizing: border-box;
          `;
          
          overlay.innerHTML = `
            <div style="background: #fff; color: #333; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 320px; width: 90%;">
              <h3 style="color: #e74c3c; margin-bottom: 1rem; font-size: 1.1rem;">âš ï¸ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h3>
              <p style="margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.4;">ì§ì›ëª…ë‹¨ì— ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.</p>
              <p style="font-size: 0.8rem; color: #666; line-height: 1.3;">ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
              <p style="font-size: 0.7rem; color: #999; margin-top: 1rem; word-break: break-all;">í˜„ì¬ ì‚¬ìš©ì: ${currentUser}</p>
            </div>
          `;
          
          document.body.appendChild(overlay);
        }
        
        // í—¤ë”ì˜ ì‚¬ìš©ì ì •ë³´ë„ ì—…ë°ì´íŠ¸
        document.getElementById('userEmployeeNumber').textContent = currentUser;
        document.getElementById('userEmployeeName').textContent = 'ê¶Œí•œ ì—†ìŒ';
      }

      // í˜ì´ì§€ í™œì„±í™” í•¨ìˆ˜ (ìœ íš¨í•œ ì‚¬ìš©ììš©)
      function enablePageForAuthorizedUser() {
        console.log('âœ… ìœ íš¨í•œ ì§ì›ë²ˆí˜¸ - í˜ì´ì§€ í™œì„±í™”');
        
        // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
        const overlay = document.getElementById('unauthorizedOverlay');
        if (overlay) {
          overlay.remove();
        }
        
        // ëª¨ë“  ì…ë ¥ ìš”ì†Œ í™œì„±í™” (ë‹¨, readonlyëŠ” ìœ ì§€)
        const allInputs = document.querySelectorAll('input, textarea, button, select');
        allInputs.forEach(element => {
          if (!element.hasAttribute('readonly')) {
            element.disabled = false;
          }
        });
        
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í™œì„±í™”
        const navBtns = document.querySelectorAll('.nav-btn');
        navBtns.forEach(btn => {
          btn.style.pointerEvents = 'auto';
          btn.style.opacity = '1';
        });
        
        // ë…¸íŠ¸ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë³µì›
        const noteCards = document.querySelectorAll('.note-card');
        noteCards.forEach(card => {
          card.style.pointerEvents = 'auto';
          card.style.opacity = '1';
        });
      }

      // ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥ì†Œì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
      function saveUserInfoToStorage(userInfo) {
        if (userInfo && userInfo.trim()) {
          try {
            sessionStorage.setItem('currentUser', userInfo.trim());
            sessionStorage.setItem('userInfo', userInfo.trim());
            sessionStorage.setItem('empNo', userInfo.trim());
            
            localStorage.setItem('currentUser', userInfo.trim());
            localStorage.setItem('userInfo', userInfo.trim());
            localStorage.setItem('empNo', userInfo.trim());
            
            console.log('ğŸ’¾ ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì™„ë£Œ:', userInfo.trim());
          } catch (error) {
            console.error('ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì—ëŸ¬:', error);
          }
        }
      }

             // ì „ì—­ ë³€ìˆ˜: ì‘ì—… ì‹¤í–‰ ì¤‘ flag (authCheck ìš°íšŒìš©ìœ¼ë¡œ window ê°ì²´ì—ë„ ë…¸ì¶œ)
       let isExecutingAction = false;
       let isSwitchingTab = false; // íƒ­ ì „í™˜ ì¤‘ í”Œë˜ê·¸ ì¶”ê°€
       
       // authCheck.jsê°€ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
       window.isExecutingAction = false;
       window.isSwitchingTab = false;

      // parent pageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
      async function getUserFromParent(skipParentCheck = false) {
        try {
          // ì‘ì—… ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ íƒ­ ì „í™˜ ì¤‘ì¼ ë•ŒëŠ” parent ì²´í¬ë¥¼ ê±´ë„ˆë›¸ ìˆ˜ ìˆë„ë¡ í•¨
          if (skipParentCheck || isExecutingAction || isSwitchingTab) {
            console.log('ğŸ”„ ì‘ì—… ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ íƒ­ ì „í™˜ ì¤‘ì´ë¯€ë¡œ ê¸°ì¡´ ì‚¬ìš©ì ì •ë³´ ìœ ì§€:', currentUser);
            if (currentUser && currentUser.trim()) {
              return;
            }
          }

          // ìƒˆë¡œìš´ ë¡œê·¸ì¸ ê°ì§€ë¥¼ ìœ„í•´ parentì—ì„œ ë¨¼ì € í™•ì¸
          let newUserFromParent = null;
          
          // ë°©ë²• 1: parent windowì—ì„œ ì§ì ‘ ì ‘ê·¼í•˜ì—¬ ìµœì‹  ì •ë³´ í™•ì¸ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
          if (window.parent && window.parent !== window && !skipParentCheck) {
            try {
              // Cross-origin ì ‘ê·¼ ì œí•œì„ ê³ ë ¤í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
              const parentUserInfo = window.parent.document.getElementById('userInfo');
              if (parentUserInfo) {
                // data-emp-no ì†ì„±ì—ì„œ ë¨¼ì € ì‹œë„
                const empNoFromData = parentUserInfo.getAttribute('data-emp-no');
                if (empNoFromData && empNoFromData.trim()) {
                  newUserFromParent = empNoFromData.trim();
                  console.log('ğŸ” Parentì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ í™•ì¸:', newUserFromParent);
                }
                
                // textContentì—ì„œ ì§ì›ë²ˆí˜¸ ì¶”ì¶œ ì‹œë„
                if (!newUserFromParent) {
                  const textContent = parentUserInfo.textContent.trim();
                  if (textContent && !textContent.includes('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤')) {
                    const match = textContent.match(/([A-Za-z0-9]+)\s*ë‹˜/);
                    if (match) {
                      newUserFromParent = match[1].toLowerCase();
                      console.log('ğŸ” Parent textContentì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ í™•ì¸:', newUserFromParent);
                    }
                  }
                }
              }
            } catch (error) {
              console.log('Parent ì ‘ê·¼ ì‹¤íŒ¨ (Cross-origin ì œí•œ ê°€ëŠ¥ì„±), ë‹¤ë¥¸ ë°©ë²• ì‹œë„');
            }
          }
          
          // ìƒˆë¡œìš´ ì‚¬ìš©ì ì •ë³´ê°€ ìˆê³  ê¸°ì¡´ê³¼ ë‹¤ë¥´ë©´ ìºì‹œ ì´ˆê¸°í™” (ë‹¨, ì‘ì—… ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ íƒ­ ì „í™˜ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
          if (newUserFromParent && newUserFromParent !== currentUser && !isExecutingAction && !isSwitchingTab) {
            console.log('ğŸ”„ ì‚¬ìš©ì ë³€ê²½ ê°ì§€:', currentUser, 'â†’', newUserFromParent);
            console.log('ğŸ—‘ï¸ ê¸°ì¡´ ìºì‹œ ì •ë³´ ì‚­ì œ');
            
            // ê¸°ì¡´ ìºì‹œëœ ì •ë³´ ëª¨ë‘ ì‚­ì œ
            currentUser = '';
            currentUserName = '';
            selectedNoteId = null;
            notes = [];
            cachedNotes = [];
            
            // ì§ì› ì •ë³´ ìºì‹œë„ ì´ˆê¸°í™”
            employeesCache = null;
            employeesCacheLoaded = false;
            
            // ì €ì¥ì†Œì—ì„œ ê¸°ì¡´ ì •ë³´ ì‚­ì œ
            try {
              sessionStorage.clear();
              localStorage.removeItem('currentUser');
              localStorage.removeItem('userInfo');
              localStorage.removeItem('empNo');
            } catch (error) {
              console.error('ìºì‹œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
            }
            
            // ìƒˆë¡œìš´ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
            currentUser = newUserFromParent;
            saveUserInfoToStorage(currentUser);
            console.log('âœ… ìƒˆë¡œìš´ ì‚¬ìš©ì ì •ë³´ë¡œ ì„¤ì •:', currentUser);
            return;
          }
          
          // ë°©ë²• 0: ì´ë¯¸ currentUserê°€ ì„¤ì •ë˜ì–´ ìˆê³  ë³€ê²½ì´ ì—†ë‹¤ë©´ ì¬ì‚¬ìš©
          if (currentUser && currentUser.trim()) {
            console.log('ğŸ”„ ê¸°ì¡´ ì‚¬ìš©ì ì •ë³´ ì¬ì‚¬ìš©:', currentUser);
            return;
          }

          // ë°©ë²• 2: sessionStorageì—ì„œ í™•ì¸ (ìƒˆë¡œê³ ì¹¨ ëŒ€ì‘)
          const sessionUser = sessionStorage.getItem('currentUser') || 
                             sessionStorage.getItem('userInfo') || 
                             sessionStorage.getItem('empNo');
          if (sessionUser && sessionUser.trim()) {
            currentUser = sessionUser.trim();
            console.log('âœ… sessionStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ë³µì›:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          const userInfoElement = document.getElementById('userInfo');
          if (userInfoElement && userInfoElement.textContent.trim()) {
            currentUser = userInfoElement.textContent.trim();
            console.log('âœ… í˜„ì¬ í˜ì´ì§€ userInfoì—ì„œ ê°€ì ¸ì˜´:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          const urlParams = new URLSearchParams(window.location.search);
          const userParam = urlParams.get('user') || urlParams.get('userId') || urlParams.get('empNo');
          if (userParam) {
            currentUser = userParam.trim();
            console.log('âœ… URL íŒŒë¼ë¯¸í„°ì—ì„œ ê°€ì ¸ì˜´:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          const localUser = localStorage.getItem('userInfo') || localStorage.getItem('currentUser') || localStorage.getItem('empNo');
          if (localUser) {
            currentUser = localUser.trim();
            console.log('âœ… localStorageì—ì„œ ê°€ì ¸ì˜´:', currentUser);
            saveUserInfoToStorage(currentUser);
            return;
          }

          // ë°©ë²• 6: postMessageë¡œ parentì—ê²Œ ìš”ì²­ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
          if (window.parent && window.parent !== window && !skipParentCheck) {
            try {
              return new Promise((resolve) => {
                const timeout = setTimeout(() => {
                  currentUser = 'test001';
                  console.log('âš ï¸ parent ì‘ë‹µ ì‹œê°„ ì´ˆê³¼, ê¸°ë³¸ê°’ ì‚¬ìš©:', currentUser);
                  saveUserInfoToStorage(currentUser);
                  resolve();
                }, 1000); // ì‹œê°„ ë‹¨ì¶• (2000 â†’ 1000)

                window.addEventListener('message', function(event) {
                  if (event.data && event.data.type === 'userInfo') {
                    clearTimeout(timeout);
                    currentUser = event.data.userId || event.data.empNo || event.data.user || 'test001';
                    console.log('âœ… postMessageë¡œ ê°€ì ¸ì˜´:', currentUser);
                    saveUserInfoToStorage(currentUser);
                    resolve();
                  }
                }, { once: true });

                try {
                  window.parent.postMessage({ type: 'requestUserInfo' }, '*');
                } catch (postError) {
                  console.log('postMessage ì „ì†¡ ì‹¤íŒ¨:', postError);
                  clearTimeout(timeout);
                  currentUser = 'test001';
                  saveUserInfoToStorage(currentUser);
                  resolve();
                }
              });
            } catch (error) {
              console.log('postMessage ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
          }

          // ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
          currentUser = 'test001';
          console.log('âš ï¸ ëª¨ë“  ë°©ë²• ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', currentUser);
          saveUserInfoToStorage(currentUser);

        } catch (error) {
          console.error('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì—ëŸ¬:', error);
          currentUser = 'test001';
          saveUserInfoToStorage(currentUser);
        }
      }

      // ì§ì› ì •ë³´ ë¡œë“œ (ìºì‹œ ì‚¬ìš©)
      async function loadUserInfo() {
        try {
          console.log('=== ì§ì› ì •ë³´ ë¡œë“œ ì‹œì‘ ===');
          console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser);
          
          if (!employeesCacheLoaded) {
            console.log('ì§ì› ìºì‹œê°€ ë¡œë”©ë˜ì§€ ì•ŠìŒ - ì´ˆê¸°í™” ì‹œì‘');
            await initializeEmployeesCache();
          }
          
          currentUserName = getEmployeeNameFromCache(currentUser);
          console.log('ì¡°íšŒëœ ì§ì›ëª…:', currentUserName);
          
          if (currentUserName === currentUser) {
            currentUserName = 'ì•Œ ìˆ˜ ì—†ìŒ';
            console.log('ì§ì›ëª…ì„ ì°¾ì§€ ëª»í•¨ - "ì•Œ ìˆ˜ ì—†ìŒ"ìœ¼ë¡œ ì„¤ì •');
          }

          document.getElementById('userEmployeeNumber').textContent = currentUser;
          document.getElementById('userEmployeeName').textContent = currentUserName;
          
          console.log('=== ì§ì› ì •ë³´ ë¡œë“œ ì™„ë£Œ ===');
        } catch (error) {
          console.error('ì§ì› ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
          currentUserName = 'ì•Œ ìˆ˜ ì—†ìŒ';
          document.getElementById('userEmployeeNumber').textContent = currentUser;
          document.getElementById('userEmployeeName').textContent = currentUserName;
        }
      }

      // í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜
      function switchToPage(pageName) {
        // íƒ­ ì „í™˜ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì • (authCheck ìš°íšŒìš©)
        isSwitchingTab = true;
        window.isSwitchingTab = true;
        console.log('ğŸ”„ íƒ­ ì „í™˜ ì‹œì‘:', pageName, '- authCheck ìš°íšŒ í™œì„±í™”');
        
        const pages = document.querySelectorAll('.page');
        const navBtns = document.querySelectorAll('.nav-btn');
        
        pages.forEach(page => page.classList.remove('active'));
        navBtns.forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(pageName + 'Page').classList.add('active');
        document.getElementById(pageName + 'PageBtn').classList.add('active');
        
        currentPage = pageName;
        console.log('í˜ì´ì§€ ì „í™˜:', pageName);
        
        // í¸ì§‘ í˜ì´ì§€ë¡œ ì „í™˜í•  ë•Œ textarea ë†’ì´ ì¬ê³„ì‚°
        if (pageName === 'editor') {
          setTimeout(() => {
            calculateOptimalTextareaHeight();
          }, 100);
        }
        
        // íƒ­ ì „í™˜ ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ (ì§€ì—° ì‹¤í–‰)
        setTimeout(() => {
          isSwitchingTab = false;
          window.isSwitchingTab = false;
          console.log('âœ… íƒ­ ì „í™˜ ì™„ë£Œ - authCheck ìš°íšŒ í•´ì œ');
        }, 500); // ì¶©ë¶„í•œ ì‹œê°„ì„ ë‘ì–´ íƒ­ ì „í™˜ì´ ì™„ì „íˆ ì™„ë£Œë˜ë„ë¡ í•¨
      }

      // ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ (ëª¨ë°”ì¼ ìµœì í™”)
      async function loadNotes() {
        try {
          console.log('ğŸ“ === ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ ì‹œì‘ ===');
          
          if (!isValidEmployee(currentUser)) {
            console.log('ğŸš« ì§ì›ëª…ë‹¨ì— ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤. í˜ì´ì§€ ì „ì²´ë¥¼ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.');
            cachedNotes = [];
            displayNotes(cachedNotes);
            disablePageForUnauthorizedUser();
            return;
          } else {
            enablePageForAuthorizedUser();
          }
          
          if (!currentDateRange.startDate || !currentDateRange.endDate) {
            initializeDateRange();
          }
          
          console.log('ğŸ“… ë‚ ì§œ ë²”ìœ„:', currentDateRange);
          console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', currentUser);
          
          // ëª¨ë°”ì¼ì—ì„œ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('ë…¸íŠ¸ ë¡œë”© ì‹œê°„ ì´ˆê³¼')), 15000);
          });
          
          const notesPromise = getNoteshareDataByDateRange(
            currentUser, 
            currentDateRange.startDate, 
            currentDateRange.endDate
          );
          
          cachedNotes = await Promise.race([notesPromise, timeoutPromise]);
          
          console.log('ğŸ“Š ì„œë²„ì—ì„œ ì¡°íšŒëœ ë…¸íŠ¸ ìˆ˜:', cachedNotes.length);
          
          const publishFilter = document.querySelector('input[name="publishFilter"]:checked')?.value || 'published';
          const filteredNotes = applyPublishFilter(cachedNotes, publishFilter);
          
          notes = filteredNotes;
          displayNotes(notes);
          
          console.log('âœ… === ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ ì™„ë£Œ ===');
        } catch (error) {
          console.error('âŒ ë…¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
          
          // ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ë” ìì„¸í•œ ì˜¤ë¥˜ ì²˜ë¦¬
          if (isMobileDevice()) {
            if (error.message.includes('ì‹œê°„ ì´ˆê³¼')) {
              await customAlert('ë„¤íŠ¸ì›Œí¬ê°€ ëŠë ¤ ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } else {
              await customAlert('ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
          } else {
            await customAlert('ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          
          // ì˜¤ë¥˜ ì‹œì—ë„ ë¹ˆ ëª©ë¡ í‘œì‹œ
          cachedNotes = [];
          notes = [];
          displayNotes(notes);
        }
      }

      // ê²Œì‹œì—¬ë¶€ í•„í„° ì ìš©
      function applyPublishFilter(notesList, publishFilter) {
        if (publishFilter === 'published') {
          return notesList.filter(note => note.ê²Œì‹œì—¬ë¶€ === 'Y');
        } else {
          return notesList;
        }
      }

      // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§ (íƒœê·¸, ë‚´ìš©, ì§ì›ëª…)
      function applyClientSideFilters(notesList, filters) {
        let filtered = [...notesList];
        
        if (filters.tag && filters.tag.trim()) {
          const tagKeyword = filters.tag.trim().toLowerCase();
          filtered = filtered.filter(note => 
            note.íƒœê·¸ && note.íƒœê·¸.toLowerCase().includes(tagKeyword)
          );
        }
        
        if (filters.content && filters.content.trim()) {
          const contentKeyword = filters.content.trim().toLowerCase();
          filtered = filtered.filter(note => 
            note.ë…¸íŠ¸ë‚´ìš© && note.ë…¸íŠ¸ë‚´ìš©.toLowerCase().includes(contentKeyword)
          );
        }
        
        if (filters.author && filters.author.trim()) {
          const authorKeyword = filters.author.trim().toLowerCase();
          filtered = filtered.filter(note => {
            let authorName = note.ì§ì›ëª…;
            if (!authorName || authorName === note.ì§ì›ë²ˆí˜¸) {
              authorName = getEmployeeNameFromCache(note.ì§ì›ë²ˆí˜¸);
            }
            return authorName && authorName.toLowerCase().includes(authorKeyword);
          });
        }
        
        return filtered;
      }

      // ë‚ ì§œ ë²”ìœ„ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      function hasDateRangeChanged(newStartDate, newEndDate) {
        return currentDateRange.startDate !== newStartDate || 
               currentDateRange.endDate !== newEndDate;
      }

      // ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ë“¤
      function formatDateForInput(dateString) {
        if (!dateString || dateString.length !== 8) return '';
        const year = dateString.substring(0, 4);
        const month = dateString.substring(4, 6);
        const day = dateString.substring(6, 8);
        return `${year}-${month}-${day}`;
      }

      function formatDateForStorage(dateString) {
        if (!dateString) return '';
        return dateString.replace(/-/g, '');
      }

      function formatDateForDisplay(dateString) {
        if (!dateString || dateString.length !== 8) return '';
        const year = dateString.substring(2, 4);
        const month = dateString.substring(4, 6);
        const day = dateString.substring(6, 8);
        return `${year}.${month}.${day}`;
      }

      // ë…¸íŠ¸ ëª©ë¡ í‘œì‹œ (ì¹´ë“œ í˜•íƒœ)
      function displayNotes(notesToDisplay) {
        const container = document.getElementById('notesContainer');
        container.innerHTML = '';

        if (notesToDisplay.length === 0) {
          container.innerHTML = '<div class="no-notes">ì¡°íšŒëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        // ê¸°ë³¸ ì •ë ¬: ë…¸íŠ¸ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ, ì§ì›ëª… ì˜¤ë¦„ì°¨ìˆœ, ë²ˆí˜¸ ì˜¤ë¦„ì°¨ìˆœ
        const sortedNotes = [...notesToDisplay].sort((a, b) => {
          const dateA = a.ë…¸íŠ¸ë‚ ì§œ || '';
          const dateB = b.ë…¸íŠ¸ë‚ ì§œ || '';
          if (dateA !== dateB) {
            return dateB.localeCompare(dateA);
          }
          
          const nameA = a.ì§ì›ëª… || getEmployeeNameFromCache(a.ì§ì›ë²ˆí˜¸) || a.ì§ì›ë²ˆí˜¸ || '';
          const nameB = b.ì§ì›ëª… || getEmployeeNameFromCache(b.ì§ì›ë²ˆí˜¸) || b.ì§ì›ë²ˆí˜¸ || '';
          if (nameA !== nameB) {
            return nameA.localeCompare(nameB);
          }
          
          const numberA = a.ë…¸íŠ¸ë²ˆí˜¸ || '';
          const numberB = b.ë…¸íŠ¸ë²ˆí˜¸ || '';
          return numberA.localeCompare(numberB);
        });

        sortedNotes.forEach(note => {
          const noteCard = document.createElement('div');
          noteCard.className = 'note-card';
          noteCard.setAttribute('data-note-id', note.id);
          
          const displayDate = formatDateForDisplay(note.ë…¸íŠ¸ë‚ ì§œ || '');
          
          let authorName = note.ì§ì›ëª…;
          if (!authorName || authorName === note.ì§ì›ë²ˆí˜¸) {
            authorName = getEmployeeNameFromCache(note.ì§ì›ë²ˆí˜¸);
          }
          
          const noteSequence = extractNoteSequence(note.ë…¸íŠ¸ë²ˆí˜¸);
          
          noteCard.innerHTML = `
            <div class="note-header">
              <div class="note-meta">
                <span class="note-category">${note.êµ¬ë¶„ || '-'}</span>
                <span class="note-date">${displayDate}</span>
                <span class="note-author">${authorName || note.ì§ì›ë²ˆí˜¸ || '-'}</span>
                <span class="note-number">#${noteSequence}</span>
              </div>
              <div class="note-publish ${note.ê²Œì‹œì—¬ë¶€ === 'N' ? 'private' : 'published'}">
                ${note.ê²Œì‹œì—¬ë¶€ === 'N' ? 'ğŸ”’' : 'ğŸŒ'}
              </div>
            </div>
            <div class="note-tags">
              ${note.íƒœê·¸ ? note.íƒœê·¸.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('') : '<span class="no-tag">íƒœê·¸ ì—†ìŒ</span>'}
            </div>
            <div class="note-content">
              ${note.ë…¸íŠ¸ë‚´ìš© || ''}
            </div>
          `;
          
          // ì¹´ë“œ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ì—ì„œ ì‹¤ìˆ˜ í´ë¦­ ë°©ì§€)
          noteCard.addEventListener('dblclick', () => {
            selectNoteForEdit(note);
          });

          // ì‹±ê¸€ í„°ì¹˜/í´ë¦­ ì‹œ ì„ íƒ í‘œì‹œë§Œ
          noteCard.addEventListener('click', () => {
            // ê¸°ì¡´ ì„ íƒ í•´ì œ
            document.querySelectorAll('.note-card').forEach(card => {
              card.classList.remove('selected');
            });
            // í˜„ì¬ ì¹´ë“œ ì„ íƒ í‘œì‹œ
            noteCard.classList.add('selected');
          });
          
          container.appendChild(noteCard);
        });
      }

      // ë…¸íŠ¸ë²ˆí˜¸ì—ì„œ ë§ˆì§€ë§‰ ë²ˆí˜¸ë§Œ ì¶”ì¶œ
      function extractNoteSequence(noteNumber) {
        if (!noteNumber) return '-';
        const parts = noteNumber.split('-');
        return parts.length > 0 ? parts[parts.length - 1] : '-';
      }

      // ë…¸íŠ¸ ì„ íƒí•˜ì—¬ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
      function selectNoteForEdit(note) {
        // ì¹´ë“œ ì„ íƒ í‘œì‹œ
        document.querySelectorAll('.note-card').forEach(card => {
          card.classList.remove('selected');
        });
        document.querySelector(`[data-note-id="${note.id}"]`).classList.add('selected');

        // í¸ì§‘ í˜ì´ì§€ë¡œ ì „í™˜
        switchToPage('editor');
        
        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        fillMainForm(note);
        
        // ì¡°íšŒ ëª¨ë“œë¡œ ì„¤ì •
        setViewMode(note);
      }

      // ì‘ì„± ëª¨ë“œ ì„¤ì •
      function setWriteMode() {
        isViewMode = false;
        isEditMode = false;
        selectedNoteId = null;
        
        document.getElementById('saveMainBtn').disabled = false;
        document.getElementById('editMainBtn').disabled = true;
        document.getElementById('deleteMainBtn').disabled = true;
        
        setFormEnabled(true);
        
        // ì¹´ë“œ ì„ íƒ í•´ì œ
        document.querySelectorAll('.note-card').forEach(card => {
          card.classList.remove('selected');
        });
      }

      // ì¡°íšŒ ëª¨ë“œ ì„¤ì •
      function setViewMode(note) {
        isViewMode = true;
        isEditMode = false;
        selectedNoteId = note.id;
        
        const canEdit = note.ì§ì›ë²ˆí˜¸ === currentUser || currentUser === 'admin' || currentUser === 's25001';
        
        document.getElementById('saveMainBtn').disabled = true;
        document.getElementById('editMainBtn').disabled = !canEdit;
        document.getElementById('deleteMainBtn').disabled = !canEdit;
        
        setFormEnabled(true, true);
      }

      // í¼ í™œì„±í™”/ë¹„í™œì„±í™”
      function setFormEnabled(enabled, readOnlyMode = false) {
        const formElements = document.querySelectorAll('#mainNoteForm input, #mainNoteForm textarea');
        formElements.forEach(element => {
          if (element.id === 'mainNumber') {
            element.disabled = true;
          } else if (readOnlyMode) {
            element.disabled = false;
          } else {
            element.disabled = !enabled;
          }
        });
        
        document.querySelectorAll('#mainNoteForm input[type="radio"]').forEach(radio => {
          if (readOnlyMode) {
            radio.disabled = false;
          } else {
            radio.disabled = !enabled;
          }
        });
        
        // ê²Œì‹œì—¬ë¶€ ë¼ë””ì˜¤ ë²„íŠ¼ë“¤ (í¼ ì™¸ë¶€)
        document.querySelectorAll('input[name="publish"]').forEach(radio => {
          if (readOnlyMode) {
            // ì¡°íšŒ ëª¨ë“œì—ì„œëŠ” ê¶Œí•œ í™•ì¸
            const canEdit = selectedNoteId && canEditNote();
            radio.disabled = !canEdit;
          } else {
            radio.disabled = !enabled;
          }
        });
        
        document.querySelectorAll('.tag-example-btn[data-target="mainTag"]').forEach(btn => {
          if (readOnlyMode) {
            btn.disabled = false;
          } else {
            btn.disabled = !enabled;
          }
        });
      }

      // ë©”ì¸ í¼ì— ë°ì´í„° ì±„ìš°ê¸°
      function fillMainForm(note) {
        const categoryRadio = document.querySelector(`input[name="category"][value="${note.êµ¬ë¶„}"]`);
        if (categoryRadio) categoryRadio.checked = true;
        
        const formattedDate = formatDateForInput(note.ë…¸íŠ¸ë‚ ì§œ || '');
        document.getElementById('mainDate').value = formattedDate;
        
        document.getElementById('mainNumber').value = note.ë…¸íŠ¸ë²ˆí˜¸ || '';
        
        if (window.setTags_mainTag) {
          window.setTags_mainTag(note.íƒœê·¸ || '');
        }
        
        const contentTextarea = document.getElementById('mainContent');
        contentTextarea.value = note.ë…¸íŠ¸ë‚´ìš© || '';
        
        // ë‚´ìš©ì´ ì±„ì›Œì§„ í›„ ë†’ì´ ì¡°ì •
        autoResizeTextarea(contentTextarea);
        
        const publishRadio = document.querySelector(`input[name="publish"][value="${note.ê²Œì‹œì—¬ë¶€ || 'Y'}"]`);
        if (publishRadio) publishRadio.checked = true;
      }

      // ë©”ì¸ í¼ ì´ˆê¸°í™”
      async function resetMainForm() {
        document.getElementById('mainNoteForm').reset();
        
        document.querySelector('input[name="category"][value="ì„¼í„°ì¥"]').checked = true;        
        document.querySelector('input[name="publish"][value="Y"]').checked = true;
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('mainDate').value = today;
        
        if (window.setTags_mainTag) {
          window.setTags_mainTag('');
        }
        
        // ë…¸íŠ¸ë‚´ìš© textarea ë†’ì´ ì´ˆê¸°í™”
        const contentTextarea = document.getElementById('mainContent');
        if (contentTextarea) {
          autoResizeTextarea(contentTextarea);
        }
        
        await updateNoteNumber();
        setWriteMode();
      }

      // ë…¸íŠ¸ë²ˆí˜¸ ì—…ë°ì´íŠ¸
      async function updateNoteNumber() {
        const dateValue = document.getElementById('mainDate').value;
        if (dateValue && currentUser) {
          try {
            const formattedDate = formatDateForStorage(dateValue);
            const noteNumber = await generateNoteNumber(currentUser, formattedDate);
            document.getElementById('mainNumber').value = noteNumber;
          } catch (error) {
            console.error('ë…¸íŠ¸ë²ˆí˜¸ ìƒì„± ì‹¤íŒ¨:', error);
          }
        }
      }

      // ìˆ˜ì • ê¶Œí•œ í™•ì¸
      function canEditNote() {
        if (!selectedNoteId) {
          return false;
        }
        
        const selectedNote = cachedNotes.find(note => note.id === selectedNoteId);
        if (!selectedNote) {
          console.error('ì„ íƒëœ ë…¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', selectedNoteId);
          return false;
        }
        
        const canEdit = selectedNote.ì§ì›ë²ˆí˜¸ === currentUser || 
                       currentUser === 'admin' || 
                       currentUser === 's25001';
        
        return canEdit;
      }

      // ë…¸íŠ¸ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      async function saveMainNote() {
        console.log('ğŸ’¾ ì €ì¥ ë²„íŠ¼ í´ë¦­');
        
        // ë¨¼ì € confirm ëª¨ë‹¬ë¡œ í™•ì¸
        const confirmed = await customConfirm('ë…¸íŠ¸ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmed) {
          return;
        }
        
        try {
          // ì‘ì—… ì‹¤í–‰ ì¤‘ í”Œë˜ê·¸ ì„¤ì • (authCheck ìš°íšŒìš©)
          isExecutingAction = true;
          window.isExecutingAction = true;
          
          // í¼ ìœ íš¨ì„± ê²€ì‚¬
          const form = document.getElementById('mainNoteForm');
          if (!form.checkValidity()) {
            await customAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }

          // ë…¸íŠ¸ ë°ì´í„° ìƒì„±
          const noteData = {
            ì§ì›ë²ˆí˜¸: currentUser,
            ì§ì›ëª…: currentUserName,
            êµ¬ë¶„: document.querySelector('input[name="category"]:checked').value,
            ë…¸íŠ¸ë‚ ì§œ: formatDateForStorage(document.getElementById('mainDate').value),
            ë…¸íŠ¸ë²ˆí˜¸: document.getElementById('mainNumber').value,
            íƒœê·¸: window.getTags_mainTag ? window.getTags_mainTag() : '',
            ë…¸íŠ¸ë‚´ìš©: document.getElementById('mainContent').value,
            ê²Œì‹œì—¬ë¶€: document.querySelector('input[name="publish"]:checked').value
          };

          console.log('ğŸ’¾ ì €ì¥ ë°ì´í„°:', noteData);

          // ì„œë²„ì— ì €ì¥ ì‹¤í–‰
          const result = await addNote(noteData);

          if (result.success) {
            // ë…¸íŠ¸ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            await loadNotes();
            
            // í¸ì§‘ íƒ­ ì´ˆê¸°í™”
            await resetMainForm();
            
            // ì¡°íšŒ íƒ­ìœ¼ë¡œ ì´ë™
            switchToPage('notes');
            
          } else {
            const errorMessage = result.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            await customAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMessage);
          }

        } catch (error) {
          console.error('ğŸ’¥ ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
          await customAlert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
          // ì‘ì—… ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
          isExecutingAction = false;
          window.isExecutingAction = false;
        }
      }

      // ë…¸íŠ¸ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      async function editMainNote() {
        console.log('ğŸ”§ ìˆ˜ì • ë²„íŠ¼ í´ë¦­');
        
        if (!selectedNoteId) {
          await customAlert('ìˆ˜ì •í•  ë…¸íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!canEditNote()) {
          await customAlert('ì´ ë…¸íŠ¸ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ë¨¼ì € confirm ëª¨ë‹¬ë¡œ í™•ì¸
        const confirmed = await customConfirm('í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ìœ¼ë¡œ ë…¸íŠ¸ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmed) {
          return;
        }
        
        try {
          // ì‘ì—… ì‹¤í–‰ ì¤‘ í”Œë˜ê·¸ ì„¤ì • (authCheck ìš°íšŒìš©)
          isExecutingAction = true;
          window.isExecutingAction = true;
          
          // í¼ ìœ íš¨ì„± ê²€ì‚¬
          const form = document.getElementById('mainNoteForm');
          if (!form.checkValidity()) {
            await customAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }

          // ë…¸íŠ¸ ë°ì´í„° ìƒì„±
          const noteData = {
            ì§ì›ë²ˆí˜¸: currentUser,
            ì§ì›ëª…: currentUserName,
            êµ¬ë¶„: document.querySelector('input[name="category"]:checked').value,
            ë…¸íŠ¸ë‚ ì§œ: formatDateForStorage(document.getElementById('mainDate').value),
            ë…¸íŠ¸ë²ˆí˜¸: document.getElementById('mainNumber').value,
            íƒœê·¸: window.getTags_mainTag ? window.getTags_mainTag() : '',
            ë…¸íŠ¸ë‚´ìš©: document.getElementById('mainContent').value,
            ê²Œì‹œì—¬ë¶€: document.querySelector('input[name="publish"]:checked').value
          };

          console.log('ğŸ”„ ìˆ˜ì • ë°ì´í„°:', noteData);

          // ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ
          console.log('ğŸ—‘ï¸ ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ ì¤‘...');
          const deleteResult = await deleteNote(selectedNoteId);
          
          if (!deleteResult.success) {
            throw new Error('ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ' + (deleteResult.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
          
          console.log('âœ… ê¸°ì¡´ ë…¸íŠ¸ ì‚­ì œ ì™„ë£Œ');

          // ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì €ì¥
          console.log('ğŸ’¾ ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì €ì¥ ì¤‘...');
          const addResult = await addNote(noteData);
          
          if (!addResult.success) {
            throw new Error('ìƒˆ ë…¸íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + (addResult.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
          
          console.log('âœ… ìƒˆ ë…¸íŠ¸ ì €ì¥ ì™„ë£Œ');

          // ë…¸íŠ¸ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
          await loadNotes();
          
          // í¸ì§‘ íƒ­ ì´ˆê¸°í™”
          await resetMainForm();
          
          // ì¡°íšŒ íƒ­ìœ¼ë¡œ ì´ë™
          switchToPage('notes');

        } catch (error) {
          console.error('ğŸ’¥ ìˆ˜ì • ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
          await customAlert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
          // ì‘ì—… ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
          isExecutingAction = false;
          window.isExecutingAction = false;
        }
      }

      // ë…¸íŠ¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      async function deleteMainNote() {
        console.log('ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­');
        
        if (!selectedNoteId) {
          await customAlert('ì‚­ì œí•  ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        if (!canEditNote()) {
          await customAlert('ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ë¨¼ì € confirm ëª¨ë‹¬ë¡œ í™•ì¸
        const confirmed = await customConfirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmed) {
          return;
        }

        try {
          // ì‘ì—… ì‹¤í–‰ ì¤‘ í”Œë˜ê·¸ ì„¤ì • (authCheck ìš°íšŒìš©)
          isExecutingAction = true;
          window.isExecutingAction = true;
          
          // ì„œë²„ì—ì„œ ë…¸íŠ¸ ì‚­ì œ ì‹¤í–‰
          const result = await deleteNote(selectedNoteId);
          
          if (result.success) {
            // ë…¸íŠ¸ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            await loadNotes();
            
            // í¸ì§‘ íƒ­ ì´ˆê¸°í™”
            await resetMainForm();
            
            // ì¡°íšŒ íƒ­ìœ¼ë¡œ ì´ë™
            switchToPage('notes');
            
          } else {
            await customAlert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
          
        } catch (error) {
          console.error('ğŸ’¥ ì‚­ì œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
          await customAlert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
          // ì‘ì—… ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
          isExecutingAction = false;
          window.isExecutingAction = false;
        }
      }

      // ê²€ìƒ‰ ìˆ˜í–‰
      async function performSearch() {
        const startDate = document.getElementById('searchStartDate').value;
        const endDate = document.getElementById('searchEndDate').value;
        const tag = document.getElementById('searchTag').value.trim();
        const content = document.getElementById('searchContent').value.trim();
        const author = document.getElementById('searchAuthor').value.trim();
        const publishFilter = document.querySelector('input[name="publishFilter"]:checked').value;

        try {
          if (!isValidEmployee(currentUser)) {
            console.log('ğŸš« ì§ì›ëª…ë‹¨ì— ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤. í˜ì´ì§€ ì „ì²´ë¥¼ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.');
            cachedNotes = [];
            displayNotes(cachedNotes);
            disablePageForUnauthorizedUser(); // í˜ì´ì§€ ì „ì²´ ë¹„í™œì„±í™”
            return;
          }

          if (hasDateRangeChanged(startDate, endDate)) {
            console.log('ë‚ ì§œ ë²”ìœ„ ë³€ê²½ë¨ - ì„œë²„ì—ì„œ ìƒˆë¡œ ì¡°íšŒ');
            
            currentDateRange.startDate = startDate;
            currentDateRange.endDate = endDate;
            
            cachedNotes = await getNoteshareDataByDateRange(currentUser, startDate, endDate);
            console.log('ìƒˆë¡œ ì¡°íšŒëœ ë…¸íŠ¸ ìˆ˜:', cachedNotes.length);
          }
          
          let filteredNotes = applyPublishFilter(cachedNotes, publishFilter);
          
          const clientFilters = { tag, content, author };
          filteredNotes = applyClientSideFilters(filteredNotes, clientFilters);
          
          console.log('ìµœì¢… í•„í„°ë§ëœ ë…¸íŠ¸ ìˆ˜:', filteredNotes.length);
          
          notes = filteredNotes;
          displayNotes(notes);
          
        } catch (error) {
          console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
          await customAlert('ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ê²€ìƒ‰ ì´ˆê¸°í™”
      function resetSearch() {
        const dateRange = initializeDateRange(); // 2ì£¼ ë²”ìœ„ë¡œ ì´ˆê¸°í™”
        document.getElementById('searchStartDate').value = dateRange.startDate;
        document.getElementById('searchEndDate').value = dateRange.endDate;
        
        document.getElementById('searchTag').value = '';
        document.getElementById('searchContent').value = '';
        document.getElementById('searchAuthor').value = '';
        
        document.querySelector('input[name="publishFilter"][value="published"]').checked = true;
        
        loadNotes();
      }

      // íƒœê·¸ ì…ë ¥ ì„¤ì •
      function setupTagInput(inputId, chipsId, hiddenId) {
        const input = document.getElementById(inputId);
        const chipsContainer = document.getElementById(chipsId);
        const hiddenInput = document.getElementById(hiddenId);
        
        if (!input || !chipsContainer || !hiddenInput) return;

        let tags = [];

        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addTagChip(input.value.trim());
          } else if (e.key === 'Backspace' && input.value === '' && tags.length > 0) {
            removeTagChip(tags.length - 1);
          }
        });

        input.addEventListener('blur', function() {
          if (input.value.trim()) {
            addTagChip(input.value.trim());
          }
        });

        function addTagChip(tagText) {
          if (!tagText || tags.includes(tagText)) return;

          tags.push(tagText);
          input.value = '';
          updateChipsDisplay();
          updateHiddenInput();
        }

        function removeTagChip(index) {
          tags.splice(index, 1);
          updateChipsDisplay();
          updateHiddenInput();
        }

        function updateChipsDisplay() {
          chipsContainer.innerHTML = '';
          if (tags.length > 0) {
            tags.forEach((tag, index) => {
              const chip = document.createElement('div');
              chip.className = 'tag-chip';
              chip.innerHTML = `
                <span>${tag}</span>
                <button type="button" class="tag-remove" onclick="removeTagByIndex(${index}, '${inputId}')">&times;</button>
              `;
              chipsContainer.appendChild(chip);
            });
            chipsContainer.style.display = 'flex';
          } else {
            chipsContainer.style.display = 'none';
          }
        }

        function updateHiddenInput() {
          hiddenInput.value = tags.join(', ');
        }

        window[`removeTagByIndex_${inputId}`] = removeTagChip;
        window.removeTagByIndex = function(index, targetInputId) {
          if (targetInputId === inputId) {
            removeTagChip(index);
          }
        };

        window[`setTags_${inputId}`] = function(tagString) {
          tags = tagString ? tagString.split(',').map(t => t.trim()).filter(t => t) : [];
          updateChipsDisplay();
          updateHiddenInput();
        };

        window[`getTags_${inputId}`] = function() {
          return tags.join(', ');
        };

        updateChipsDisplay();
      }

      // íƒœê·¸ ì˜ˆì‹œì—ì„œ íƒœê·¸ ì¶”ê°€
      function addTagFromExample(tag, targetId = 'mainTag') {
        if (targetId === 'mainTag') {
          const input = document.getElementById(targetId);
          input.value = tag;
          const event = new KeyboardEvent('keydown', { key: 'Enter' });
          input.dispatchEvent(event);
          
          // íšŒì›ìƒë‹´ íƒœê·¸ì¼ ê²½ìš° ë…¸íŠ¸ë‚´ìš©ì— í…œí”Œë¦¿ ì¶”ê°€
          if (tag === 'íšŒì›ìƒë‹´') {
            const contentTextarea = document.getElementById('mainContent');
                const template = `1. ìƒë‹´ì¼ì‹œ : 

2. ê¸°ë³¸ì •ë³´ :
 - ë³´í˜¸ìëª… ë° ì—°ë½ì²˜ : 
 - ì–´ë¥´ì‹  ëª… :
 - ìš”ì–‘ë“±ê¸‰ : 
 - ë‚˜ì´ :
 - ì£¼ì†Œ :

3. ì–´ë¥´ì‹  ì§„ë‹¨ :

4. ê¸°ëŠ¥ìƒíƒœ :

5. ì‹œì„¤ì´ìš© íŠ¹ì´ì‚¬í•­ : 

6. ê¸°íƒ€ ìš”êµ¬ì‚¬í•­ ë“± :`;
            
            // ê¸°ì¡´ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆ í›„ ì¶”ê°€, ì—†ìœ¼ë©´ ë°”ë¡œ ì¶”ê°€
            if (contentTextarea.value.trim()) {
              contentTextarea.value += '\n\n' + template;
            } else {
              contentTextarea.value = template;
            }
            
            // í…œí”Œë¦¿ ì¶”ê°€ í›„ ë†’ì´ ì¡°ì •
            autoResizeTextarea(contentTextarea);
          }
        }
      }

      // ì»¤ìŠ¤í…€ Alert í•¨ìˆ˜
      function customAlert(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById('customAlertModal');
          const messageElement = document.getElementById('alertMessage');
          const okBtn = document.getElementById('alertOkBtn');
          
          messageElement.textContent = message;
          modal.style.display = 'block';
          
          function closeAlert() {
            modal.style.display = 'none';
            okBtn.removeEventListener('click', closeAlert);
            document.removeEventListener('keydown', handleKeyDown);
            resolve();
          }
          
          function handleKeyDown(e) {
            if (e.key === 'Enter' || e.key === 'Escape') {
              closeAlert();
            }
          }
          
          okBtn.addEventListener('click', closeAlert);
          document.addEventListener('keydown', handleKeyDown);
          
          setTimeout(() => okBtn.focus(), 100);
        });
      }

      // ì»¤ìŠ¤í…€ Confirm í•¨ìˆ˜
      function customConfirm(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById('customConfirmModal');
          const messageElement = document.getElementById('confirmMessage');
          const okBtn = document.getElementById('confirmOkBtn');
          const cancelBtn = document.getElementById('confirmCancelBtn');
          
          messageElement.textContent = message;
          modal.style.display = 'block';
          
          function closeConfirm(result) {
            modal.style.display = 'none';
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            document.removeEventListener('keydown', handleKeyDown);
            resolve(result);
          }
          
          function handleOk() {
            closeConfirm(true);
          }
          
          function handleCancel() {
            closeConfirm(false);
          }
          
          function handleKeyDown(e) {
            if (e.key === 'Enter') {
              closeConfirm(true);
            } else if (e.key === 'Escape') {
              closeConfirm(false);
            }
          }
          
          okBtn.addEventListener('click', handleOk);
          cancelBtn.addEventListener('click', handleCancel);
          document.addEventListener('keydown', handleKeyDown);
          
          setTimeout(() => cancelBtn.focus(), 100);
        });
      }

      // ê¸°ì¡´ alertì™€ confirmì„ ì»¤ìŠ¤í…€ ëª¨ë‹¬ë¡œ ëŒ€ì²´
      window.alert = customAlert;
      window.confirm = customConfirm;



      // í˜ì´ì§€ ë¡œë”© ì‹œ textarea ìµœì  ë†’ì´ ê³„ì‚° í•¨ìˆ˜
      function calculateOptimalTextareaHeight() {
        try {
          const textarea = document.getElementById('mainContent');
          if (!textarea) return;

          // ì „ì²´ ë·°í¬íŠ¸ ë†’ì´
          const viewportHeight = window.innerHeight;
          
          // ìƒë‹¨ ìš”ì†Œë“¤ì˜ ë†’ì´ ê³„ì‚°
          const navHeight = 45; // --nav-height CSS ë³€ìˆ˜ê°’
          const headerHeight = 50; // --header-height CSS ë³€ìˆ˜ê°’
          
          // í¸ì§‘ í˜ì´ì§€ì˜ ë‹¤ë¥¸ ìš”ì†Œë“¤ ë†’ì´ ê³„ì‚°
          const editorSection = document.querySelector('.editor-section');
          if (!editorSection) return;
          
          // textareaë¥¼ ì œì™¸í•œ ë‹¤ë¥¸ í¼ ìš”ì†Œë“¤ì˜ ë†’ì´ ê³„ì‚°
          const formGroups = editorSection.querySelectorAll('.form-group:not(.textarea-container)');
          let otherElementsHeight = 0;
          
          formGroups.forEach(group => {
            otherElementsHeight += group.offsetHeight || 0;
          });
          
          // ë²„íŠ¼ ì„¹ì…˜ ë†’ì´
          const buttonSection = editorSection.querySelector('.button-section');
          if (buttonSection) {
            otherElementsHeight += buttonSection.offsetHeight || 0;
          }
          
          // íŒ¨ë”©ê³¼ ë§ˆì§„ ì—¬ìœ ê³µê°„ (ì•½ 60px)
          const paddingMarginSpace = 60;
          
          // ì‚¬ìš© ê°€ëŠ¥í•œ ë†’ì´ ê³„ì‚°
          const availableHeight = viewportHeight - navHeight - headerHeight - otherElementsHeight - paddingMarginSpace;
          
          // ìµœì†Œ ë†’ì´ì™€ ìµœëŒ€ ë†’ì´ ì œí•œ
          const minHeight = 120;
          const maxHeight = Math.max(availableHeight, minHeight);
          
          // textarea ë†’ì´ ì„¤ì •
          textarea.style.height = maxHeight + 'px';
          
          console.log('ğŸ“ Textarea ìµœì  ë†’ì´ ê³„ì‚°:', {
            viewportHeight: viewportHeight,
            navHeight: navHeight,
            headerHeight: headerHeight,
            otherElementsHeight: otherElementsHeight,
            availableHeight: availableHeight,
            finalHeight: maxHeight
          });
          
        } catch (error) {
          console.error('Textarea ë†’ì´ ê³„ì‚° ì¤‘ ì˜¤ë¥˜:', error);
        }
      }

      // textarea ë†’ì´ ìë™ ì¡°ì • í•¨ìˆ˜ - ì™„ì „íˆ ìƒˆë¡œìš´ êµ¬í˜„
      function autoResizeTextarea(textarea) {
        if (!textarea) return;
        
        // í˜ì´ì§€ ë¡œë”© ì‹œì—ëŠ” ìµœì  ë†’ì´ë¥¼ ê³„ì‚°
        if (!textarea.value || textarea.value.trim() === '') {
          calculateOptimalTextareaHeight();
          return;
        }
        
        // ì„ì‹œë¡œ ë†’ì´ë¥¼ autoë¡œ ì„¤ì •í•˜ì—¬ ì‹¤ì œ ë‚´ìš© ë†’ì´ ì¸¡ì •
        const originalHeight = textarea.style.height;
        textarea.style.height = 'auto';
        
        // ì‹¤ì œ ìŠ¤í¬ë¡¤ ë†’ì´ ì¸¡ì •
        const scrollHeight = textarea.scrollHeight;
        const minHeight = 120;
        
        // ìµœì¢… ë†’ì´ ê³„ì‚°
        const finalHeight = Math.max(scrollHeight, minHeight);
        
        // ë†’ì´ ì ìš©
        textarea.style.height = finalHeight + 'px';
        
        // ì½˜ì†”ì— ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
        console.log('ğŸ“ Textarea ë†’ì´ ìë™ ì¡°ì •:', {
          scrollHeight: scrollHeight,
          minHeight: minHeight,
          finalHeight: finalHeight,
          previousHeight: originalHeight
        });
        
        // ë†’ì´ ë³€ê²½ í›„ ìŠ¤í¬ë¡¤ ì¡°ì •
        requestAnimationFrame(() => {
          if (document.activeElement === textarea) {
            textarea.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'nearest' 
            });
          }
        });
      }

      // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ì„ ì•„ë˜ë¡œ ë‚´ë¦¬ëŠ” í•¨ìˆ˜
      function scrollToBottomSmooth() {
        try {
          // í˜„ì¬ í™œì„±í™”ëœ í˜ì´ì§€ í™•ì¸
          const activePage = document.querySelector('.page.active');
          if (!activePage) return;

          // í¸ì§‘ í˜ì´ì§€ì¸ ê²½ìš°ì—ë§Œ ìŠ¤í¬ë¡¤
          if (activePage.id === 'editorPage') {
            const textarea = document.getElementById('mainContent');
            if (textarea) {
              // í…ìŠ¤íŠ¸ ì˜ì—­ì„ í™”ë©´ì— ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
              textarea.scrollIntoView({
                behavior: 'smooth',
                block: 'end',
                inline: 'nearest'
              });

              // ì¶”ê°€ë¡œ ì—ë””í„° ì„¹ì…˜ë„ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
              const editorSection = activePage.querySelector('.editor-section');
              if (editorSection) {
                setTimeout(() => {
                  editorSection.scrollTo({
                    top: editorSection.scrollHeight,
                    behavior: 'smooth'
                  });
                }, 200);
              }
            }
          }
        } catch (error) {
          console.error('ìŠ¤í¬ë¡¤ ì´ë™ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }

      // ì´ˆê¸° í¼ ì„¤ì •
      async function initializeForm() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('mainDate').value = today;
        
        await updateNoteNumber();
        setWriteMode();
        
        // í˜ì´ì§€ ë¡œë”© ì‹œ textarea ìµœì  ë†’ì´ ê³„ì‚°
        setTimeout(() => {
          calculateOptimalTextareaHeight();
        }, 200);
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      function setupEventListeners() {
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('notesPageBtn').addEventListener('click', () => {
          switchToPage('notes');
        });
        
        document.getElementById('editorPageBtn').addEventListener('click', () => {
          switchToPage('editor');
        });

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('resetBtn').addEventListener('click', resetSearch);
        
        // ê²€ìƒ‰ ì…ë ¥ í•„ë“œë“¤ì˜ Enter í‚¤ ì´ë²¤íŠ¸
        ['searchTag', 'searchContent', 'searchAuthor'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                performSearch();
              }
            });
          }
        });

        // ê²Œì‹œì—¬ë¶€ í•„í„° ë³€ê²½ ì‹œ ìë™ ê²€ìƒ‰
        document.querySelectorAll('input[name="publishFilter"]').forEach(radio => {
          radio.addEventListener('change', performSearch);
        });

        // ë©”ì¸ í¼ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('saveMainBtn').addEventListener('click', function(e) {
          e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
          console.log('ğŸ–±ï¸ ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨!');
          saveMainNote();
        });
        document.getElementById('editMainBtn').addEventListener('click', function(e) {
          e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
          editMainNote();
        });
        document.getElementById('deleteMainBtn').addEventListener('click', function(e) {
          e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
          deleteMainNote();
        });
        document.getElementById('resetMainBtn').addEventListener('click', function(e) {
          e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
          resetMainForm();
        });

        // ë‚ ì§œ ë³€ê²½ ì‹œ ë…¸íŠ¸ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        document.getElementById('mainDate').addEventListener('change', updateNoteNumber);

        // íƒœê·¸ ì…ë ¥ ì´ë²¤íŠ¸
        setupTagInput('mainTag', 'mainTagChips', 'mainTagHidden');

        // íƒœê·¸ ì˜ˆì‹œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.tag-example-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const target = this.dataset.target || 'mainTag';
            addTagFromExample(this.dataset.tag, target);
          });
        });

        // ë…¸íŠ¸ë‚´ìš© ì…ë ¥ í•„ë“œ ìë™ ë†’ì´ ì¡°ì • ì‹œìŠ¤í…œ - ì™„ì „íˆ ìƒˆë¡œìš´ êµ¬í˜„
        const mainContentTextarea = document.getElementById('mainContent');
        if (mainContentTextarea) {
          console.log('ğŸš€ Textarea ìë™ ë†’ì´ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
          
          // ì´ˆê¸° ë†’ì´ ì„¤ì •
          autoResizeTextarea(mainContentTextarea);

          // input ì´ë²¤íŠ¸ - íƒ€ì´í•‘í•  ë•Œë§ˆë‹¤ ë†’ì´ ì¡°ì •
          mainContentTextarea.addEventListener('input', function() {
            console.log('âŒ¨ï¸ Input ì´ë²¤íŠ¸ ë°œìƒ');
            autoResizeTextarea(this);
          });

          // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸
          mainContentTextarea.addEventListener('paste', function() {
            console.log('ğŸ“‹ Paste ì´ë²¤íŠ¸ ë°œìƒ');
            // ë¶™ì—¬ë„£ê¸° ë‚´ìš©ì´ ë°˜ì˜ëœ í›„ ë†’ì´ ì¡°ì •
            setTimeout(() => {
              autoResizeTextarea(this);
            }, 50);
          });

          // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (Enter, Backspace ë“±)
          mainContentTextarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === 'Backspace' || e.key === 'Delete') {
              setTimeout(() => {
                autoResizeTextarea(this);
              }, 10);
            }
          });

          // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸
          mainContentTextarea.addEventListener('focus', function() {
            console.log('ğŸ¯ Focus ì´ë²¤íŠ¸ ë°œìƒ');
            autoResizeTextarea(this);
            
            // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ëŒ€ì‘
            setTimeout(() => {
              scrollToBottomSmooth();
            }, 500);
          });

          // ì°½ í¬ê¸° ë³€ê²½ ì‹œì—ë„ ë†’ì´ ì¬ì¡°ì •
          window.addEventListener('resize', function() {
            // í¸ì§‘ í˜ì´ì§€ê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
            if (currentPage === 'editor') {
              setTimeout(() => {
                if (document.activeElement === mainContentTextarea) {
                  autoResizeTextarea(mainContentTextarea);
                } else {
                  // í¬ì»¤ìŠ¤ê°€ ì—†ì„ ë•ŒëŠ” ìµœì  ë†’ì´ ì¬ê³„ì‚°
                  calculateOptimalTextareaHeight();
                }
              }, 100);
            }
          });
        }

        // ë·°í¬íŠ¸ í¬ê¸° ë³€ê²½ ê°ì§€ (ëª¨ë°”ì¼ í‚¤ë³´ë“œ ëŒ€ì‘)
        let initialViewportHeight = window.innerHeight;
        window.addEventListener('resize', function() {
          // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì™€ì„œ ë·°í¬íŠ¸ê°€ ì¤„ì–´ë“  ê²½ìš°
          if (window.innerHeight < initialViewportHeight * 0.8) {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id === 'mainContent') {
              setTimeout(() => {
                scrollToBottomSmooth();
              }, 300);
            }
          } else {
            // í‚¤ë³´ë“œê°€ ë‚´ë ¤ê°„ ê²½ìš° ì´ˆê¸° ë†’ì´ ì—…ë°ì´íŠ¸
            initialViewportHeight = window.innerHeight;
          }
        });

        // ë¸Œë¼ìš°ì € íƒ­ í™œì„±í™” ì‹œ ì‚¬ìš©ì ì •ë³´ ì¬í™•ì¸
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            console.log('ğŸ”’ íƒ­ ë¹„í™œì„±í™” - ë³´ì•ˆ ëª¨ë“œ');
          } else {
            console.log('ğŸ‘ï¸ íƒ­ í™œì„±í™” - ì‚¬ìš©ì ì •ë³´ ì¬í™•ì¸');
            // íƒ­ì´ ë‹¤ì‹œ í™œì„±í™”ë  ë•Œ ì‚¬ìš©ì ì •ë³´ ì¬í™•ì¸ (ì‘ì—… ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ íƒ­ ì „í™˜ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
            setTimeout(async () => {
              if (!isExecutingAction && !isSwitchingTab) {
                await getUserFromParent(false);
                await loadUserInfo();
              }
            }, 100);
          }
        });
      }

      // ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€ ë° ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”
      function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }

      // ì•ˆì „í•œ ì´ˆê¸°í™” í•¨ìˆ˜
      async function safeInitialize() {
        try {
          console.log('ğŸ“± ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ì•ˆì „í•œ ì´ˆê¸°í™” ì‹œì‘');
          
          // Supabase ë¡œë”© í™•ì¸
          if (typeof window.supabase === 'undefined') {
            console.error('âŒ Supabaseê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            showErrorMessage('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
          }

          // 1. ì§ì› ì •ë³´ ìºì‹œ ì´ˆê¸°í™” (ê°€ì¥ ë¨¼ì €)
          console.log('ğŸ“‹ ì§ì› ì •ë³´ ìºì‹œ ì´ˆê¸°í™”...');
          await initializeEmployeesCache();
          
          // 2. parent pageì—ì„œ ì‚¬ë²ˆ ê°€ì ¸ì˜¤ê¸°
          console.log('ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°...');
          await getUserFromParent(false);

          // 3. í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
          console.log('ğŸ” ì‚¬ìš©ì ì •ë³´ ë¡œë“œ...');
          await loadUserInfo();
          
          // 4. ë‚ ì§œ ë²”ìœ„ ì´ˆê¸°í™” ë° UI ì„¤ì •
          console.log('ğŸ“… ë‚ ì§œ ë²”ìœ„ ì´ˆê¸°í™”...');
          const dateRange = initializeDateRange();
          const startDateEl = document.getElementById('searchStartDate');
          const endDateEl = document.getElementById('searchEndDate');
          if (startDateEl) startDateEl.value = dateRange.startDate;
          if (endDateEl) endDateEl.value = dateRange.endDate;
          
          // 5. ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ
          console.log('ğŸ“ ë…¸íŠ¸ ëª©ë¡ ë¡œë“œ...');
          await loadNotes();

          // 6. ì´ˆê¸° ì„¤ì •
          console.log('âš™ï¸ í¼ ì´ˆê¸°í™”...');
          await initializeForm();

          // 7. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
          console.log('ğŸ¯ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡...');
          setupEventListeners();

          console.log('âœ… ëª¨ë°”ì¼ í™˜ê²½ ì´ˆê¸°í™” ì™„ë£Œ');
          
        } catch (error) {
          console.error('ğŸ’¥ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          showErrorMessage('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          font-family: "Noto Sans KR", sans-serif;
          text-align: center;
          padding: 20px;
          box-sizing: border-box;
        `;
        errorDiv.innerHTML = `
          <div style="background: #fff; color: #333; padding: 20px; border-radius: 10px; max-width: 300px;">
            <h3 style="color: #e74c3c; margin-bottom: 15px;">âš ï¸ ì˜¤ë¥˜</h3>
            <p style="margin-bottom: 15px; line-height: 1.4;">${message}</p>
            <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        `;
        document.body.appendChild(errorDiv);
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ“± ëª¨ë°”ì¼ í˜ì´ì§€ ë¡œë“œ ê°ì§€');
        console.log('ğŸŒ User Agent:', navigator.userAgent);
        console.log('ğŸ“Š í™”ë©´ í¬ê¸°:', window.innerWidth + 'x' + window.innerHeight);
        console.log('ğŸ”— í˜„ì¬ URL:', window.location.href);
        console.log('ğŸŒ ì˜¨ë¼ì¸ ìƒíƒœ:', navigator.onLine);
        
        // ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ ì²´í¬
        if (!navigator.onLine) {
          showErrorMessage('ì¸í„°ë„· ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™” (ëª¨ë°”ì¼ì—ì„œ ì•ˆì •ì„± í–¥ìƒ)
        setTimeout(safeInitialize, 100);
      });

      // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
      window.addEventListener('online', function() {
        console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
      });

      window.addEventListener('offline', function() {
        console.log('ğŸš« ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠì–´ì§');
        showErrorMessage('ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      });
    </script>
  </body>
</html>